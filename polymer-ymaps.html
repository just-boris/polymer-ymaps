<link rel="import" href="ymaps-api.html">
<link rel="import" href="http://www.polymer-project.org/components/polymer/polymer.html">

<!--
Element providing yandex-map for your site.

##### Example
```
<yandex-map center="{{center}}" zoom="{{zoom}}"></yandex-map>
```
@element yandex-map
@status alpha
@homepage http://just-boris.github.io/polymer-ymaps
-->
<polymer-element name="yandex-map" attributes="center zoom">
  <template>
    <style id="style">
      :host {
        position: relative;
      }
      #map {
        position: absolute;
        overflow: hidden;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>
    <div id="map"></div>
  </template>
  <script>
    (function () {
      var stylesWatcher = {
        components: [],
        styles: "",
        initialize: function () {
          var observer = new MutationObserver(this.onMutate.bind(this));
          observer.observe(document.head, {childList: true});
        },
        onMutate: function (mutations) {
          var newStyles = mutations.reduce(function (total, mutation) {
            if (mutation.addedNodes.length > 0) {
              total += Array.prototype.slice.apply(mutation.addedNodes).filter(function (tag) {
                return tag.tagName.toLowerCase() === 'style' && tag.textContent.match(/^.ymaps-/)
              }).map(function(tag) {
                return tag.textContent;
              }).join('\n');
            }
            return total;
          }, "");
          if(newStyles.length > 0) {
            this.components.forEach(function(component) {
              this.applyStyle(component, newStyles);
            }, this);
            this.styles += newStyles;
          }
        },
        applyStyle: function(component, style) {
          component.$.style.textContent += style;
        },
        register: function (component) {
          this.applyStyle(component, this.styles);
          this.components.push(component);
        }
      };
      stylesWatcher.initialize();

      Polymer('yandex-map', {

        /**
         * Center of the map. Array with to items &mdash; latitude and longitude
         *
         * @attribute center
         * @type Array
         */
        center: [42, 24],

        /**
         * Zoom.
         *
         * @attribute zoom
         * @type Number
         */
        zoom: 6,

        ready: function () {
          stylesWatcher.register(this);
          var self = this;
          ymaps.ready(function () {
            self.map = self.createMap();
          });
        },

        createMap: function () {
          return new ymaps.Map(this.$.map, {
            center: this.center,
            zoom: this.zoom
          });
        }
      });
    })();
  </script>
</polymer-element>